<!DOCTYPE html>
<html lang="en-us" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Detect the Source Code of List Watch Between API Server and Controller - LittleDriver</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="xuran" />
  <meta name="description" content="写在前面 在上一篇blog 中，我们从源码的角度来分析了 Kubernetes 中的List-Watch机制的部分内容。它更注重于 API Server 和 etcd 之间的交互。通过下面的这幅 Kubernetes" />







<meta name="generator" content="Hugo 0.51" />


<link rel="canonical" href="http://littledriver.net/post/2018/11/22/detect-the-source-code-of-list-watch-between-api-server-and-controller/" />



<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.f384a7fa4673433bc34e238c5074bb1303d90e5d5a29a2ffbaf61226ef213c29.css" integrity="sha256-84Sn&#43;kZzQzvDTiOMUHS7EwPZDl1aKaL/uvYSJu8hPCk=" media="screen">





<meta property="og:title" content="Detect the Source Code of List Watch Between API Server and Controller" />
<meta property="og:description" content="写在前面 在上一篇blog 中，我们从源码的角度来分析了 Kubernetes 中的List-Watch机制的部分内容。它更注重于 API Server 和 etcd 之间的交互。通过下面的这幅 Kubernetes" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://littledriver.net/post/2018/11/22/detect-the-source-code-of-list-watch-between-api-server-and-controller/" /><meta property="article:published_time" content="2018-11-22T09:12:21&#43;08:00"/>
<meta property="article:modified_time" content="2018-11-22T09:12:21&#43;08:00"/>

<meta itemprop="name" content="Detect the Source Code of List Watch Between API Server and Controller">
<meta itemprop="description" content="写在前面 在上一篇blog 中，我们从源码的角度来分析了 Kubernetes 中的List-Watch机制的部分内容。它更注重于 API Server 和 etcd 之间的交互。通过下面的这幅 Kubernetes">


<meta itemprop="datePublished" content="2018-11-22T09:12:21&#43;08:00" />
<meta itemprop="dateModified" content="2018-11-22T09:12:21&#43;08:00" />
<meta itemprop="wordCount" content="5658">



<meta itemprop="keywords" content="Kubernetes," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Detect the Source Code of List Watch Between API Server and Controller"/>
<meta name="twitter:description" content="写在前面 在上一篇blog 中，我们从源码的角度来分析了 Kubernetes 中的List-Watch机制的部分内容。它更注重于 API Server 和 etcd 之间的交互。通过下面的这幅 Kubernetes"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">LittleDriver</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://littledriver.net/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://littledriver.net/categories/">Categories</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://littledriver.net/tags/">Tags</a>
          
        
      </li>
    
  </ul>
</nav>


  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      LittleDriver
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://littledriver.net/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://littledriver.net/categories/">Categories</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://littledriver.net/tags/">Tags</a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Detect the Source Code of List Watch Between API Server and Controller</h1>
      
      <div class="post-meta">
        <time datetime="2018-11-22" class="post-time">
          2018-11-22
        </time>
        <div class="post-category">
            <a href="http://littledriver.net/categories/%E5%B7%A5%E4%BD%9C%E4%BA%86%E4%B9%9F%E4%B8%8D%E8%83%BD%E6%94%BE%E6%9D%BE%E7%B3%BB%E5%88%97/"> 工作了也不能放松系列 </a>
            
          </div>
        

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#写在前面">写在前面</a></li>
<li><a href="#controllermanager">ControllerManager</a>
<ul>
<li><a href="#startcontrollers">StartControllers</a></li>
<li><a href="#newcontrollerinitializers">NewControllerInitializers</a></li>
<li><a href="#controllercontext">controllerContext</a></li>
<li><a href="#controllercontext-informerfactory">controllerContext.InformerFactory</a>
<ul>
<li><a href="#informer">informer</a></li>
<li><a href="#run">Run</a>
<ul>
<li><a href="#controller-run">controller.Run</a></li>
</ul></li>
</ul></li>
<li><a href="#回到-controller-manager">回到 Controller Manager</a></li>
</ul></li>
<li><a href="#replicasetcontroller">ReplicaSetController</a></li>
<li><a href="#链接-replicasetcontroller-和-controllercontext-informerfactory">链接 ReplicaSetController 和 controllerContext.InformerFactory</a></li>
<li><a href="#结束语">结束语</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<h2 id="写在前面">写在前面</h2>

<p>在上一篇blog 中，我们从源码的角度来分析了 Kubernetes 中的<code>List-Watch</code>机制的部分内容。它更注重于 API Server 和 etcd 之间的交互。通过下面的这幅 Kubernetes 的架构图和<code>List-Watch</code>机制的时序图我们可以知道，API Server 通过<code>List-Watch</code>机制获取到的资源对象的信息还将用于 Kubernetes 内置的 Controller 和我们自定义的 Controller，甚至是 Scheduler 和 Kubelet。</p>

<p><img src="http://o6sfmikvw.bkt.clouddn.com/list1" alt="" /></p>

<p><img src="http://o6sfmikvw.bkt.clouddn.com/EAE14BFE-CD40-444E-A2E6-FBE8178F2F8E.png" alt="" /></p>

<p>本文我们将通过对<code>ReplicaSetController</code>源码的分析来了解，API Server 保存的和资源对象有关的数据到底是怎么流动到 Controller（目的组件）中的，以及最终这些数据是如何被处理的。</p>

<h2 id="controllermanager">ControllerManager</h2>

<p>Kubernetes 中一个非常重要的组件就是：ControllerManager。它负责管理集群内部各个资源控制器（Controller） 的启停。通过阅读 ControManager 的代码可以很容易的发现，它在运行起来的时候会启动 Kubernetes 内置的各个 Controller。（下面的实例我截取了部分关键的逻辑，完整版的链接：<a href="https://github.com/kubernetes/kubernetes/blob/f48e18faa4dc035cc927c6a2b34c83c8475b55fa/cmd/kube-controller-manager/app/controllermanager.go#L207">kubernetes/controllermanager.go at f48e18faa4dc035cc927c6a2b34c83c8475b55fa · kubernetes/kubernetes · GitHub</a>
）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">	<span class="nx">run</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">...</span>
		<span class="nx">controllerContext</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">CreateControllerContext</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">rootClientBuilder</span><span class="p">,</span> <span class="nx">clientBuilder</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">())</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">klog</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;error building controller context: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="o">...</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">StartControllers</span><span class="p">(</span><span class="nx">controllerContext</span><span class="p">,</span> <span class="nx">saTokenControllerInitFunc</span><span class="p">,</span> <span class="nf">NewControllerInitializers</span><span class="p">(</span><span class="nx">controllerContext</span><span class="p">.</span><span class="nx">LoopMode</span><span class="p">),</span> <span class="nx">unsecuredMux</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">klog</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;error starting controllers: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>

		<span class="nx">controllerContext</span><span class="p">.</span><span class="nx">InformerFactory</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">controllerContext</span><span class="p">.</span><span class="nx">Stop</span><span class="p">)</span>
		<span class="nb">close</span><span class="p">(</span><span class="nx">controllerContext</span><span class="p">.</span><span class="nx">InformersStarted</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>上述逻辑有几个值得注意的点：</p>

<ol>
<li>StartControllers</li>
<li>NewControllerInitializers</li>
<li>controllerContext

<ol>
<li>controllerContext.InformerFactory.Start</li>
</ol></li>
</ol>

<h3 id="startcontrollers">StartControllers</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">StartControllers</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">ControllerContext</span><span class="p">,</span> <span class="nx">startSATokenController</span> <span class="nx">InitFunc</span><span class="p">,</span> <span class="nx">controllers</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">InitFunc</span><span class="p">,</span> <span class="nx">unsecuredMux</span> <span class="o">*</span><span class="nx">mux</span><span class="p">.</span><span class="nx">PathRecorderMux</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
<span class="o">...</span>
	<span class="k">for</span> <span class="nx">controllerName</span><span class="p">,</span> <span class="nx">initFn</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">controllers</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">!</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">IsControllerEnabled</span><span class="p">(</span><span class="nx">controllerName</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">glog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;%q is disabled&#34;</span><span class="p">,</span> <span class="nx">controllerName</span><span class="p">)</span>
			<span class="k">continue</span>
		<span class="p">}</span>

<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">wait</span><span class="p">.</span><span class="nf">Jitter</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">ComponentConfig</span><span class="p">.</span><span class="nx">Generic</span><span class="p">.</span><span class="nx">ControllerStartInterval</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span> <span class="nx">ControllerStartJitter</span><span class="p">))</span>

		<span class="nx">glog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Starting %q&#34;</span><span class="p">,</span> <span class="nx">controllerName</span><span class="p">)</span>
		<span class="nx">debugHandler</span><span class="p">,</span> <span class="nx">started</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">initFn</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>StartControllers 的逻辑比较简单，它遍历了一个存有 Controller 的 Map，依次调用 Controller 的启动函数<code>initFn</code>。这个 Map 是通过函数参数传递进来的，对这个参数进行赋值的位置也正是<code>NewControllerInitializers</code>函数被调用的位置。</p>

<h3 id="newcontrollerinitializers">NewControllerInitializers</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">NewControllerInitializers</span><span class="p">(</span><span class="nx">loopMode</span> <span class="nx">ControllerLoopMode</span><span class="p">)</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">InitFunc</span> <span class="p">{</span>
	<span class="nx">controllers</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">InitFunc</span><span class="p">{}</span>
	<span class="nx">controllers</span><span class="p">[</span><span class="s">&#34;endpoint&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">startEndpointController</span>
	<span class="nx">controllers</span><span class="p">[</span><span class="s">&#34;replicationcontroller&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">startReplicationController</span>
	<span class="nx">controllers</span><span class="p">[</span><span class="s">&#34;podgc&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">startPodGCController</span>
	<span class="nx">controllers</span><span class="p">[</span><span class="s">&#34;resourcequota&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">startResourceQuotaController</span>
	<span class="nx">controllers</span><span class="p">[</span><span class="s">&#34;namespace&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">startNamespaceController</span>
	<span class="nx">controllers</span><span class="p">[</span><span class="s">&#34;serviceaccount&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">startServiceAccountController</span>
	<span class="nx">controllers</span><span class="p">[</span><span class="s">&#34;garbagecollector&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">startGarbageCollectorController</span>
	<span class="nx">controllers</span><span class="p">[</span><span class="s">&#34;daemonset&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">startDaemonSetController</span>
	<span class="nx">controllers</span><span class="p">[</span><span class="s">&#34;job&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">startJobController</span>
	<span class="nx">controllers</span><span class="p">[</span><span class="s">&#34;deployment&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">startDeploymentController</span>
	<span class="nx">controllers</span><span class="p">[</span><span class="s">&#34;replicaset&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">startReplicaSetController</span>
	<span class="nx">controllers</span><span class="p">[</span><span class="s">&#34;horizontalpodautoscaling&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">startHPAController</span>
	<span class="nx">controllers</span><span class="p">[</span><span class="s">&#34;disruption&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">startDisruptionController</span>
	<span class="nx">controllers</span><span class="p">[</span><span class="s">&#34;statefulset&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">startStatefulSetController</span></code></pre></td></tr></table>
</div>
</div>
<p>截取该函数的部分逻辑就可以看出，它构造了一个 key 为 Controller 名字，value 为 Controller 创建函数的 Map。</p>

<h3 id="controllercontext">controllerContext</h3>

<p>有了 <code>NewControllerInitializers</code>和<code>StartControllers</code>的出现，按理说 Controller 就可以启动了。但是我们发现在<code>StartControllers</code>函数调用的位置，传递进去了一个比较特殊的参数：<code>controllerContext</code>，它是通过<code>CreateControllerContext</code>函数创建的。</p>

<p>查看<code>CreateControllerContext</code>函数逻辑后发现并没有什么特别的地方，唯一值得注意的就是一个名为<code>sharedInformers</code>的变量。因为他在 ControllerManager 中的 Run 函数内调用了自己的 Start 方法。</p>

<h3 id="controllercontext-informerfactory">controllerContext.InformerFactory</h3>

<p><code>controllerContext.InformerFactory</code>被我们在上面说到<code>sharedInformers</code>赋值。根据创建<code>shardInformers</code> 的流程跟进下去，我们发现它的核心逻辑在这里：<a href="https://github.com/kubernetes/kubernetes/blob/7f23a743e8c23ac6489340bbb34fa6f1d392db9d/staging/src/k8s.io/apiextensions-apiserver/pkg/client/informers/externalversions/factory.go#L91">kubernetes/factory.go at 7f23a743e8c23ac6489340bbb34fa6f1d392db9d · kubernetes/kubernetes · GitHub</a>。并且同时发现，它所实现的 Start 函数，其实是通过遍历其内部一个名为<code>informers</code>的Map，调用了每一个<code>informer</code>实现的 Run 函数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// NewSharedInformerFactoryWithOptions constructs a new instance of a SharedInformerFactory with additional options.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewSharedInformerFactoryWithOptions</span><span class="p">(</span><span class="nx">client</span> <span class="nx">kubernetes</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="nx">defaultResync</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span> <span class="nx">options</span> <span class="o">...</span><span class="nx">SharedInformerOption</span><span class="p">)</span> <span class="nx">SharedInformerFactory</span> <span class="p">{</span>
	<span class="nx">factory</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">sharedInformerFactory</span><span class="p">{</span>
		<span class="nx">client</span><span class="p">:</span>           <span class="nx">client</span><span class="p">,</span>
		<span class="nx">namespace</span><span class="p">:</span>        <span class="nx">v1</span><span class="p">.</span><span class="nx">NamespaceAll</span><span class="p">,</span>
		<span class="nx">defaultResync</span><span class="p">:</span>    <span class="nx">defaultResync</span><span class="p">,</span>
		<span class="nx">informers</span><span class="p">:</span>        <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">Type</span><span class="p">]</span><span class="nx">cache</span><span class="p">.</span><span class="nx">SharedIndexInformer</span><span class="p">),</span>
		<span class="nx">startedInformers</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">Type</span><span class="p">]</span><span class="kt">bool</span><span class="p">),</span>
		<span class="nx">customResync</span><span class="p">:</span>     <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">Type</span><span class="p">]</span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">),</span>
	<span class="p">}</span>

	<span class="c1">// Apply all options
</span><span class="c1"></span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">opt</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">options</span> <span class="p">{</span>
		<span class="nx">factory</span> <span class="p">=</span> <span class="nf">opt</span><span class="p">(</span><span class="nx">factory</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">factory</span>
<span class="p">}</span>

<span class="c1">// Start initializes all requested informers.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">sharedInformerFactory</span><span class="p">)</span> <span class="nf">Start</span><span class="p">(</span><span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="p">{</span>
	<span class="nx">f</span><span class="p">.</span><span class="nx">lock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">f</span><span class="p">.</span><span class="nx">lock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

	<span class="k">for</span> <span class="nx">informerType</span><span class="p">,</span> <span class="nx">informer</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">f</span><span class="p">.</span><span class="nx">informers</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">!</span><span class="nx">f</span><span class="p">.</span><span class="nx">startedInformers</span><span class="p">[</span><span class="nx">informerType</span><span class="p">]</span> <span class="p">{</span>
			<span class="k">go</span> <span class="nx">informer</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">)</span>
			<span class="nx">f</span><span class="p">.</span><span class="nx">startedInformers</span><span class="p">[</span><span class="nx">informerType</span><span class="p">]</span> <span class="p">=</span> <span class="kc">true</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>那么现在看起来，这个<code>informer</code>和其 Run 函数的实现就值得我们再去深入的了解一下了。</p>

<h4 id="informer">informer</h4>

<p>Informer 的数据类型是<code>cache.SharedIndexInformer</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// SharedInformer has a shared data cache and is capable of distributing notifications for changes
</span><span class="c1">// to the cache to multiple listeners who registered via AddEventHandler. If you use this, there is
</span><span class="c1">// one behavior change compared to a standard Informer.  When you receive a notification, the cache
</span><span class="c1">// will be AT LEAST as fresh as the notification, but it MAY be more fresh.  You should NOT depend
</span><span class="c1">// on the contents of the cache exactly matching the notification you&#39;ve received in handler
</span><span class="c1">// functions.  If there was a create, followed by a delete, the cache may NOT have your item.  This
</span><span class="c1">// has advantages over the broadcaster since it allows us to share a common cache across many
</span><span class="c1">// controllers. Extending the broadcaster would have required us keep duplicate caches for each
</span><span class="c1">// watch.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">SharedInformer</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// AddEventHandler adds an event handler to the shared informer using the shared informer&#39;s resync
</span><span class="c1"></span>	<span class="c1">// period.  Events to a single handler are delivered sequentially, but there is no coordination
</span><span class="c1"></span>	<span class="c1">// between different handlers.
</span><span class="c1"></span>	<span class="nf">AddEventHandler</span><span class="p">(</span><span class="nx">handler</span> <span class="nx">ResourceEventHandler</span><span class="p">)</span>
	<span class="c1">// AddEventHandlerWithResyncPeriod adds an event handler to the shared informer using the
</span><span class="c1"></span>	<span class="c1">// specified resync period.  Events to a single handler are delivered sequentially, but there is
</span><span class="c1"></span>	<span class="c1">// no coordination between different handlers.
</span><span class="c1"></span>	<span class="nf">AddEventHandlerWithResyncPeriod</span><span class="p">(</span><span class="nx">handler</span> <span class="nx">ResourceEventHandler</span><span class="p">,</span> <span class="nx">resyncPeriod</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span>
	<span class="c1">// GetStore returns the Store.
</span><span class="c1"></span>	<span class="nf">GetStore</span><span class="p">()</span> <span class="nx">Store</span>
	<span class="c1">// GetController gives back a synthetic interface that &#34;votes&#34; to start the informer
</span><span class="c1"></span>	<span class="nf">GetController</span><span class="p">()</span> <span class="nx">Controller</span>
	<span class="c1">// Run starts the shared informer, which will be stopped when stopCh is closed.
</span><span class="c1"></span>	<span class="nf">Run</span><span class="p">(</span><span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
	<span class="c1">// HasSynced returns true if the shared informer&#39;s store has synced.
</span><span class="c1"></span>	<span class="nf">HasSynced</span><span class="p">()</span> <span class="kt">bool</span>
	<span class="c1">// LastSyncResourceVersion is the resource version observed when last synced with the underlying
</span><span class="c1"></span>	<span class="c1">// store. The value returned is not synchronized with access to the underlying store and is not
</span><span class="c1"></span>	<span class="c1">// thread-safe.
</span><span class="c1"></span>	<span class="nf">LastSyncResourceVersion</span><span class="p">()</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">SharedIndexInformer</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">SharedInformer</span>
	<span class="c1">// AddIndexers add indexers to the informer before it starts.
</span><span class="c1"></span>	<span class="nf">AddIndexers</span><span class="p">(</span><span class="nx">indexers</span> <span class="nx">Indexers</span><span class="p">)</span> <span class="kt">error</span>
	<span class="nf">GetIndexer</span><span class="p">()</span> <span class="nx">Indexer</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>通过它的数据结构的定义以及注释我们兴奋的发现，<code>SharedIndexInformer</code>类型的对象可能正是多个 Controller 从 API Server 接收资源对象信息的一个入口。总结下来，<code>SharedIndexInformer</code>有如下几个特点：</p>

<ol>
<li><p>它和 API Server 一样，在内部会维护一个缓存。一旦缓存的内容有变化，它将通知给关心这些消息的对象。「关心」的方式很简单，就是自己实现这些消息的处理函数，并将它们注册到<code>SharedIndexInformer</code>类型的实例中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// ResourceEventHandlerFuncs is an adaptor to let you easily specify as many or
</span><span class="c1">// as few of the notification functions as you want while still implementing
</span><span class="c1">// ResourceEventHandler.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ResourceEventHandlerFuncs</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">AddFunc</span>    <span class="kd">func</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span>
	<span class="nx">UpdateFunc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">oldObj</span><span class="p">,</span> <span class="nx">newObj</span> <span class="kd">interface</span><span class="p">{})</span>
	<span class="nx">DeleteFunc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p><code>SharedIndexInformer</code> 所维护的缓存将尽量保证其中的内容和实时的资源对象的信息一致。但是我们不能够依赖通过 event 形式发来的资源对象的信息和缓存内容之间的匹配关系。如过一个资源对象的创建和删除操作发生的间隔时间比较短，那么缓存中最终是没有这个资源对象的信息的。这非常符合 Kubernetes 的开发理念：保持数据的最终一致性。</p></li>
</ol>

<h4 id="run">Run</h4>

<p>大概了解了<code>informer</code> 的实现原理后，我们来看下它的 Run 函数的逻辑：
<a href="https://github.com/kubernetes/client-go/blob/ee7a1ba5cdf1292b67a1fdf1fa28f90d2a7b0084/tools/cache/shared_informer.go#L189">client-go/shared_informer.go at ee7a1ba5cdf1292b67a1fdf1fa28f90d2a7b0084 · kubernetes/client-go · GitHub</a></p>

<p>在去掉了一些干扰性的信息之后，我们发现，Run 函数做的核心工作有两点：</p>

<ol>
<li>通过配置信息创建一个 controller 对象</li>
<li>调用这个 controller 对象的 Run 函数</li>
</ol>

<h5 id="controller-run">controller.Run</h5>

<p>在 controller 对象的 Run 函数中我们发现，它创建了一个让我们非常熟悉的对象：Reflector。 这个类型为 Reflector 的对象之前在 API Server 中也被创建过:<a href="http://littledriver.net/post/2018/11/21/detect-the-source-code-of-list-watch-between-api-server-and-etcd/#reflector-cache-reflector">Detect the Source Code of List Watch Between API Server and Etcd - LittleDriver</a>。它有两个比较重要的功能：</p>

<ol>
<li>封装了 List/Watch 等方法在 listerWatcher 成员内部，用于后期调用获取资源对象的数据</li>
<li>维护了一个缓存（以队列的形式实现），存储获取到的资源对象的数据</li>
</ol>

<p>controller.Run 函数在末尾调用了 Reflector 对象的 Run 函数， 其内部的核心逻辑就是调用listerWatcher 成员的 ListWatch 方法，开始等待接受资源对象的信息。这部分和 API Server 等待接收来自 ectd 的消息原理是一样的。</p>

<p>除此之外，它还调用了一个名为<code>processLoop</code>的函数。这个函数的工作也很简单：不断的从 Reflector对象维护的资源对象信息的缓存中取出消息进行处理。</p>

<h3 id="回到-controller-manager">回到 Controller Manager</h3>

<p>通过递归的观察 Controller Manager 的 Run 函数的逻辑，我们基本上可以确定下一阶段要关注的重点：informer 的创建者。因为这整段的逻辑看下来，最终通过<code>List-Watch</code>机制获取资源对象信息的是 informer。而 informer 的创建逻辑并没有在<code>controllerContext.InformerFactory</code>对象初始化的时候完成。那么也就是说，它是在之后的逻辑中对其内部的 informer 成员赋值的。</p>

<p>再次查看<code>StartControllers</code>的逻辑可知，持有<code>controllerContext.InformerFactory</code>对象的<code>controllerContext</code>，作为参数被传递到了每一个 Controller 的初始化函数。所以，看起来 informer 肯定是在各个 Controller 的逻辑中被赋值的。</p>

<h2 id="replicasetcontroller">ReplicaSetController</h2>

<p>ReplicaSetController 的初始化函数如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">startReplicaSetController</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">ControllerContext</span><span class="p">)</span> <span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">AvailableResources</span><span class="p">[</span><span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersionResource</span><span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;apps&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1&#34;</span><span class="p">,</span> <span class="nx">Resource</span><span class="p">:</span> <span class="s">&#34;replicasets&#34;</span><span class="p">}]</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">nil</span>
	<span class="p">}</span>
	<span class="k">go</span> <span class="nx">replicaset</span><span class="p">.</span><span class="nf">NewReplicaSetController</span><span class="p">(</span>
		<span class="nx">ctx</span><span class="p">.</span><span class="nx">InformerFactory</span><span class="p">.</span><span class="nf">Apps</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">ReplicaSets</span><span class="p">(),</span>
		<span class="nx">ctx</span><span class="p">.</span><span class="nx">InformerFactory</span><span class="p">.</span><span class="nf">Core</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">Pods</span><span class="p">(),</span>
		<span class="nx">ctx</span><span class="p">.</span><span class="nx">ClientBuilder</span><span class="p">.</span><span class="nf">ClientOrDie</span><span class="p">(</span><span class="s">&#34;replicaset-controller&#34;</span><span class="p">),</span>
		<span class="nx">replicaset</span><span class="p">.</span><span class="nx">BurstReplicas</span><span class="p">,</span>
	<span class="p">).</span><span class="nf">Run</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">ComponentConfig</span><span class="p">.</span><span class="nx">ReplicaSetController</span><span class="p">.</span><span class="nx">ConcurrentRSSyncs</span><span class="p">),</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">Stop</span><span class="p">)</span>
	<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>可以看出在一开始调用 ReplicaSetController 的创建函数的时候，我们就传递进去了两个 Informer。选择<code>ReplicaSets</code>函数跟进去发现，它返回是一个类型为<code>replicaSetInformer</code>的对象。而<code>replicaSetInformer</code>这个类实现了一个名为<code>Informer</code>的方法，它返回的正式一个我们前面说到的<code>SharedIndexInformer</code>类型的对象。我们之前要找的和各个 Controller 相关的 informer 对象也是<code>SharedIndexInformer</code>类型。通过查看<code>Informer</code>函数的逻辑，它一共涉及到以下三个函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// NewFilteredReplicaSetInformer constructs a new informer for ReplicaSet type.
</span><span class="c1">// Always prefer using an informer factory to get a shared informer instead of getting an independent
</span><span class="c1">// one. This reduces memory footprint and number of connections to the server.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewFilteredReplicaSetInformer</span><span class="p">(</span><span class="nx">client</span> <span class="nx">kubernetes</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="nx">namespace</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">resyncPeriod</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span> <span class="nx">indexers</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">Indexers</span><span class="p">,</span> <span class="nx">tweakListOptions</span> <span class="nx">internalinterfaces</span><span class="p">.</span><span class="nx">TweakListOptionsFunc</span><span class="p">)</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">SharedIndexInformer</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">NewSharedIndexInformer</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="nx">cache</span><span class="p">.</span><span class="nx">ListWatch</span><span class="p">{</span>
			<span class="nx">ListFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">options</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="nx">tweakListOptions</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
					<span class="nf">tweakListOptions</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">options</span><span class="p">)</span>
				<span class="p">}</span>
				<span class="k">return</span> <span class="nx">client</span><span class="p">.</span><span class="nf">AppsV1</span><span class="p">().</span><span class="nf">ReplicaSets</span><span class="p">(</span><span class="nx">namespace</span><span class="p">).</span><span class="nf">List</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
			<span class="p">},</span>
			<span class="nx">WatchFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">options</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">watch</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="nx">tweakListOptions</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
					<span class="nf">tweakListOptions</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">options</span><span class="p">)</span>
				<span class="p">}</span>
				<span class="k">return</span> <span class="nx">client</span><span class="p">.</span><span class="nf">AppsV1</span><span class="p">().</span><span class="nf">ReplicaSets</span><span class="p">(</span><span class="nx">namespace</span><span class="p">).</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
			<span class="p">},</span>
		<span class="p">},</span>
		<span class="o">&amp;</span><span class="nx">appsv1</span><span class="p">.</span><span class="nx">ReplicaSet</span><span class="p">{},</span>
		<span class="nx">resyncPeriod</span><span class="p">,</span>
		<span class="nx">indexers</span><span class="p">,</span>
	<span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">replicaSetInformer</span><span class="p">)</span> <span class="nf">defaultInformer</span><span class="p">(</span><span class="nx">client</span> <span class="nx">kubernetes</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="nx">resyncPeriod</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">SharedIndexInformer</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nf">NewFilteredReplicaSetInformer</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">f</span><span class="p">.</span><span class="nx">namespace</span><span class="p">,</span> <span class="nx">resyncPeriod</span><span class="p">,</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">Indexers</span><span class="p">{</span><span class="nx">cache</span><span class="p">.</span><span class="nx">NamespaceIndex</span><span class="p">:</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">MetaNamespaceIndexFunc</span><span class="p">},</span> <span class="nx">f</span><span class="p">.</span><span class="nx">tweakListOptions</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">replicaSetInformer</span><span class="p">)</span> <span class="nf">Informer</span><span class="p">()</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">SharedIndexInformer</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">f</span><span class="p">.</span><span class="nx">factory</span><span class="p">.</span><span class="nf">InformerFor</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">appsv1</span><span class="p">.</span><span class="nx">ReplicaSet</span><span class="p">{},</span> <span class="nx">f</span><span class="p">.</span><span class="nx">defaultInformer</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>看起来，关键的部分大概有两个：</p>

<ol>
<li>实际创建这个 Informer 对象的函数应该是<code>NewFilteredReplicaSetInformer</code>方法</li>
<li>而<code>NewFilteredReplicaSetInformer</code>方法作为参数传到了我们前面提到的<code>controllerContext.InformerFactory</code>对象的<code>InformerFor</code>方法中</li>
</ol>

<p>最终，我们通过查看<code>InformerFor</code>方法的逻辑可知，<code>NewFilteredReplicaSetInformer</code> 最终在这里被调用，生成一个 informer 对象返回给外部。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// InternalInformerFor returns the SharedIndexInformer for obj using an internal
</span><span class="c1">// client.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">sharedInformerFactory</span><span class="p">)</span> <span class="nf">InformerFor</span><span class="p">(</span><span class="nx">obj</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="nx">newFunc</span> <span class="nx">internalinterfaces</span><span class="p">.</span><span class="nx">NewInformerFunc</span><span class="p">)</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">SharedIndexInformer</span> <span class="p">{</span>
	<span class="nx">f</span><span class="p">.</span><span class="nx">lock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">f</span><span class="p">.</span><span class="nx">lock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

	<span class="nx">informerType</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
	<span class="nx">informer</span><span class="p">,</span> <span class="nx">exists</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">informers</span><span class="p">[</span><span class="nx">informerType</span><span class="p">]</span>
	<span class="k">if</span> <span class="nx">exists</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">informer</span>
	<span class="p">}</span>

	<span class="nx">resyncPeriod</span><span class="p">,</span> <span class="nx">exists</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">customResync</span><span class="p">[</span><span class="nx">informerType</span><span class="p">]</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">exists</span> <span class="p">{</span>
		<span class="nx">resyncPeriod</span> <span class="p">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">defaultResync</span>
	<span class="p">}</span>

	<span class="nx">informer</span> <span class="p">=</span> <span class="nf">newFunc</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">client</span><span class="p">,</span> <span class="nx">resyncPeriod</span><span class="p">)</span>
	<span class="nx">f</span><span class="p">.</span><span class="nx">informers</span><span class="p">[</span><span class="nx">informerType</span><span class="p">]</span> <span class="p">=</span> <span class="nx">informer</span>

	<span class="k">return</span> <span class="nx">informer</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>而<code>Informer</code>方法调用的位置是在ReplicaSetController 创建函数中：<a href="https://github.com/kubernetes/kubernetes/blob/a3ccea9d8743f2ff82e41b6c2af6dc2c41dc7b10/pkg/controller/replicaset/replica_set.go#L141">kubernetes/replica_set.go at a3ccea9d8743f2ff82e41b6c2af6dc2c41dc7b10 · kubernetes/kubernetes · GitHub</a>。并且，同时还通过<code>informer</code>对象向<code>controllerContext.InformerFactory</code>注册了相应的 Handler 函数，以便之后处理接收到的资源对象的信息。</p>

<h2 id="链接-replicasetcontroller-和-controllercontext-informerfactory">链接 ReplicaSetController 和 controllerContext.InformerFactory</h2>

<p>之所以要看下 <code>ReplicaSetController</code> 和<code>controllerContext.InformerFactory</code>是如何建立链接开始交互的，是因为 ReplicaSetController 最终还是要靠之前提到的<code>Reflector</code>对象调用 List/Watch方法从 API Server 接受资源对象的信息。而这个 <code>Reflector</code>对象是被实现在<code>controllerContext.InformerFactory</code>中的。</p>

<p>返回上面提到<code>informer</code> 对象调用<code>Run</code>的地方，我们发现，<code>Reflector</code>对象是借助了<code>informer</code> 对象的<code>listWatcher</code>成员创建的。而这个<code>listWatcher</code>成员是在<code>informer</code>对象被创建的时候就赋值进去了，赋值的位置就是<code>NewFilteredReplicaSetInformer</code>函数。</p>

<p>截止到目前为止，我们找到了资源对象信息的生产者:<code>Reflector</code>，也找到了这些信息的消费者:<code>ReplicaSetController</code>为其<code>informer</code> 注册的处理函数。那么这个消息是如何从生产者送到消费者的呢？</p>

<p>返回<code>Reflector</code>对象被创建的位置：<a href="https://github.com/kubernetes/client-go/blob/03bfb9bdcfe5482795b999f39ca3ed9ad42ce5bb/tools/cache/controller.go#L100">client-go/controller.go at 03bfb9bdcfe5482795b999f39ca3ed9ad42ce5bb · kubernetes/client-go · GitHub</a>。我们发现它除了执行生产消息塞入缓存的逻辑<code>wg.StartWithChannel(stopCh, r.Run)</code>，还调用了一个名为<code>processLoop</code>的函数。跟进去之后发现，该函数的功能是不断的从缓存中取出有效的内容（资源对象的信息）并通过一个函数<code>c.config.Process</code>对其进行处理：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">controller</span><span class="p">)</span> <span class="nf">processLoop</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="nx">obj</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Queue</span><span class="p">.</span><span class="nf">Pop</span><span class="p">(</span><span class="nf">PopProcessFunc</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Process</span><span class="p">))</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">FIFOClosedError</span> <span class="p">{</span>
				<span class="k">return</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">RetryOnError</span> <span class="p">{</span>
				<span class="c1">// This is the safe way to re-enqueue.
</span><span class="c1"></span>				<span class="nx">c</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">Queue</span><span class="p">.</span><span class="nf">AddIfNotPresent</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>函数<code>c.config.Process</code>是在 informer 对象 Run 起来的时候被创建的，也就是上面提到的 controller 对象被创建的地方：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">sharedIndexInformer</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="p">{</span>
	<span class="k">defer</span> <span class="nx">utilruntime</span><span class="p">.</span><span class="nf">HandleCrash</span><span class="p">()</span>

	<span class="nx">fifo</span> <span class="o">:=</span> <span class="nf">NewDeltaFIFO</span><span class="p">(</span><span class="nx">MetaNamespaceKeyFunc</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">indexer</span><span class="p">)</span>

	<span class="nx">cfg</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Config</span><span class="p">{</span>
		<span class="nx">Queue</span><span class="p">:</span>            <span class="nx">fifo</span><span class="p">,</span>
		<span class="nx">ListerWatcher</span><span class="p">:</span>    <span class="nx">s</span><span class="p">.</span><span class="nx">listerWatcher</span><span class="p">,</span>
		<span class="nx">ObjectType</span><span class="p">:</span>       <span class="nx">s</span><span class="p">.</span><span class="nx">objectType</span><span class="p">,</span>
		<span class="nx">FullResyncPeriod</span><span class="p">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">resyncCheckPeriod</span><span class="p">,</span>
		<span class="nx">RetryOnError</span><span class="p">:</span>     <span class="kc">false</span><span class="p">,</span>
		<span class="nx">ShouldResync</span><span class="p">:</span>     <span class="nx">s</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nx">shouldResync</span><span class="p">,</span>

		<span class="nx">Process</span><span class="p">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">HandleDeltas</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">s</span><span class="p">.</span><span class="nx">startedLock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
		<span class="k">defer</span> <span class="nx">s</span><span class="p">.</span><span class="nx">startedLock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

		<span class="nx">s</span><span class="p">.</span><span class="nx">controller</span> <span class="p">=</span> <span class="nf">New</span><span class="p">(</span><span class="nx">cfg</span><span class="p">)</span>
		<span class="nx">s</span><span class="p">.</span><span class="nx">controller</span><span class="p">.(</span><span class="o">*</span><span class="nx">controller</span><span class="p">).</span><span class="nx">clock</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">clock</span>
		<span class="nx">s</span><span class="p">.</span><span class="nx">started</span> <span class="p">=</span> <span class="kc">true</span>
	<span class="p">}()</span></code></pre></td></tr></table>
</div>
</div>
<p>其中<code>HandleDeltas</code>便是函数<code>c.config.Process</code>的实际值。接下来，我们可以跟进到<code>HandleDeltas</code>函数的内部一探究竟：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">sharedIndexInformer</span><span class="p">)</span> <span class="nf">HandleDeltas</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">blockDeltas</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">s</span><span class="p">.</span><span class="nx">blockDeltas</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

	<span class="c1">// from oldest to newest
</span><span class="c1"></span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">d</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">obj</span><span class="p">.(</span><span class="nx">Deltas</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="nx">d</span><span class="p">.</span><span class="nx">Type</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">Sync</span><span class="p">,</span> <span class="nx">Added</span><span class="p">,</span> <span class="nx">Updated</span><span class="p">:</span>
			<span class="nx">isSync</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">Type</span> <span class="o">==</span> <span class="nx">Sync</span>
			<span class="nx">s</span><span class="p">.</span><span class="nx">cacheMutationDetector</span><span class="p">.</span><span class="nf">AddObject</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span>
			<span class="k">if</span> <span class="nx">old</span><span class="p">,</span> <span class="nx">exists</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">indexer</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Object</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">exists</span> <span class="p">{</span>
				<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">indexer</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Object</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
					<span class="k">return</span> <span class="nx">err</span>
				<span class="p">}</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nf">distribute</span><span class="p">(</span><span class="nx">updateNotification</span><span class="p">{</span><span class="nx">oldObj</span><span class="p">:</span> <span class="nx">old</span><span class="p">,</span> <span class="nx">newObj</span><span class="p">:</span> <span class="nx">d</span><span class="p">.</span><span class="nx">Object</span><span class="p">},</span> <span class="nx">isSync</span><span class="p">)</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">indexer</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Object</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
					<span class="k">return</span> <span class="nx">err</span>
				<span class="p">}</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nf">distribute</span><span class="p">(</span><span class="nx">addNotification</span><span class="p">{</span><span class="nx">newObj</span><span class="p">:</span> <span class="nx">d</span><span class="p">.</span><span class="nx">Object</span><span class="p">},</span> <span class="nx">isSync</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="nx">Deleted</span><span class="p">:</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">indexer</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Object</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">err</span>
			<span class="p">}</span>
			<span class="nx">s</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nf">distribute</span><span class="p">(</span><span class="nx">deleteNotification</span><span class="p">{</span><span class="nx">oldObj</span><span class="p">:</span> <span class="nx">d</span><span class="p">.</span><span class="nx">Object</span><span class="p">},</span> <span class="kc">false</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>对于从缓存中取出的每一个 event（资源对象的信息），在<code>HandleDeltas</code>中都会被判定eventType，然后交由<code>processor.distribute</code>方法继续处理。而在<code>processor.distribute</code>方法的内部，我们发现 event 最终给了 processor 的 listener 成员：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">sharedProcessor</span><span class="p">)</span> <span class="nf">distribute</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">sync</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">p</span><span class="p">.</span><span class="nx">listenersLock</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">p</span><span class="p">.</span><span class="nx">listenersLock</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>

	<span class="k">if</span> <span class="nx">sync</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">listener</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">p</span><span class="p">.</span><span class="nx">syncingListeners</span> <span class="p">{</span>
			<span class="nx">listener</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">listener</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">p</span><span class="p">.</span><span class="nx">listeners</span> <span class="p">{</span>
			<span class="nx">listener</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>由于这个 Processor 对象是 informer 对象的一个内部成员，但是我在查找 ReplicaSet 的 informer 被创建的逻辑的时候并没有发现 Processor.Listeners 或 p.syncingListeners 被赋值。但是我找到了Processor 实现的一个名为 <code>addListener</code>的方法。它看起来是专门为了添加 listener 成员给存在的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">sharedProcessor</span><span class="p">)</span> <span class="nf">addListener</span><span class="p">(</span><span class="nx">listener</span> <span class="o">*</span><span class="nx">processorListener</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">p</span><span class="p">.</span><span class="nx">listenersLock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">p</span><span class="p">.</span><span class="nx">listenersLock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

	<span class="nx">p</span><span class="p">.</span><span class="nf">addListenerLocked</span><span class="p">(</span><span class="nx">listener</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">listenersStarted</span> <span class="p">{</span>
		<span class="nx">p</span><span class="p">.</span><span class="nx">wg</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">listener</span><span class="p">.</span><span class="nx">run</span><span class="p">)</span>
		<span class="nx">p</span><span class="p">.</span><span class="nx">wg</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">listener</span><span class="p">.</span><span class="nx">pop</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>查看该函数的调用位置可知，仅有一处，在<code>sharedIndexInformer</code>类的<code>AddEventHandlerWithResyncPeriod</code>方法中。看着这个函数名我觉得非常的熟悉，并且它又是属于<code>sharedIndexInformer</code>类，很可能和 informer 对象有关。那也就是说，它可能和 ReplicaSetController 也有关系，毕竟 <code>informer</code> 对象就是在 ReplicaSetController 的 New 函数中被创建的。</p>

<p>此时，我返回ReplicaSetController的 New 函数。我发现它在创建了<code>informer</code> 对象之后还执行了一个名为 AddHandler 的函数，将处理 event 的函数通过<code>informer</code>对象向<code>controllerContext.InformerFactory</code>注册了相应的 Handler 函数。跟进 AddHandler 这个函数之后我们发现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">sharedIndexInformer</span><span class="p">)</span> <span class="nf">AddEventHandler</span><span class="p">(</span><span class="nx">handler</span> <span class="nx">ResourceEventHandler</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">.</span><span class="nf">AddEventHandlerWithResyncPeriod</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">defaultEventHandlerResyncPeriod</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>果然，我们上面提到的处理 event 的 listener 就是 ReplicaSetController 注册的 Handler 函数。</p>

<h2 id="结束语">结束语</h2>

<p>至此，从 ControllerManager 到 API Server 之间通过 List-Watch 机制处理资源对象信息的过程也就梳理完成了。如果你此时返回到本文头部给出的 List-Watch 机制时序图，就可以发现，其实我们这整个一篇 blog，都在说 List-Watch-1这个虚线框内，标号为 0， 4的过程。而标号为2，3的两个过程，真是我们昨天讲的，API Server 和 ectd 交互的过程。</p>

    </div>

    
    

    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="http://littledriver.net/tags/kubernetes/">Kubernetes</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/2018/11/23/detect-the-mechanism-of-scheduling-in-kubernetes/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Detect the Mechanism of Scheduling in Kubernetes</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/2018/11/21/detect-the-source-code-of-list-watch-between-api-server-and-etcd/">
            <span class="next-text nav-default">Detect the Source Code of List Watch Between API Server and Etcd</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  

  <div class="disqus-comment">
  <div class="disqus-button" id="load_disqus" onclick="load_disqus()">
    Show Disqus Comments
  </div>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
      this.page.url = "http://littledriver.net/post/2018/11/22/detect-the-source-code-of-list-watch-between-api-server-and-controller/";
    };
    function load_disqus() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'fengzixu';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

      $('#load_disqus').remove();
    };
  </script>
  <noscript>Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
  </noscript>
  
  </div>
  
    



        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
  
    <a href="mailto:hnustphoenix@email.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://twitter.com/Haier0715" rel="me noopener" class="iconfont"
      title="twitter"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1264 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M1229.8616 18.043658c0 0-117.852626 63.135335-164.151872 67.344358-105.225559-164.151872-505.082682-92.598492-437.738325 223.078185C278.622548 312.675223 89.216542 47.506814 89.216542 47.506814s-117.852626 189.406006 75.762402 345.139833C127.097743 396.85567 55.544363 371.601535 55.544363 371.601535S26.081207 535.753407 253.368414 615.724832c-21.045112 29.463156-113.643603 8.418045-113.643603 8.418045s25.254134 143.10676 231.496229 180.987961c-143.10676 130.479693-387.230056 92.598492-370.393967 105.225559 206.242095 189.406006 1119.599946 231.496229 1128.01799-643.98042C1179.353331 249.539887 1263.533778 123.269217 1263.533778 123.269217s-130.479693 37.881201-138.897738 33.672179C1225.652577 98.015083 1229.8616 18.043658 1229.8616 18.043658"></path>
</svg>

    </a>
  
    <a href="https://github.com/fengzixu" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="http://littledriver.net/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
  
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
       -
    2019
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        xuran
        
      </span></span>

  
  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ="></script>














  <script id="dsq-count-scr" src="//fengzixu.disqus.com/count.js" async></script>





</body>
</html>
